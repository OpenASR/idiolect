name: Publish to MarketPlace
# All commits to `master` will result in an attempt to publish to Marketplace, but will fail if the version is not updated
# Tagging `v*.*.*` on release/ or main branch will update the version and create a GitHub release - see release.yml

env:
  INTELLIJ_PUBLISH_TOKEN: ${{ secrets.INTELLIJ_PUBLISH_TOKEN }}
  INTELLIJ_CERTIFICATE_CHAIN: ${{ secrets.INTELLIJ_CERTIFICATE_CHAIN }}
  INTELLIJ_PRIVATE_KEY: ${{ secrets.INTELLIJ_PRIVATE_KEY }}
  INTELLIJ_PRIVATE_KEY_PASSWORD: ${{ secrets.INTELLIJ_PRIVATE_KEY_PASSWORD }}

on:
  push:
    branches: [ master ]
#    paths:
#      - build.gradle.kts
#      - CHANGELOG.md
  pull_request:
    branches: [ master ]

jobs:
  Build_and_Publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17

      # Needed until Vosk provide a new release to fix Windows issues
      - name: Checkout vosk-api
        uses: actions/checkout@v3
        with:
          repository: alphacep/vosk-api
          ref: fff40ce1a1f1b921272a184acfd0c21350750789
          path: vosk-api
      - name: Build & install Vosk with working native libraries
        run: |
          cd vosk-api/java/lib/src/main/resources
          wget -q https://repo1.maven.org/maven2/com/alphacephei/vosk/0.3.38/vosk-0.3.38.jar
          unzip -nq vosk-0.3.38.jar
          rm -rf META-INF org
          rm vosk-0.3.38.jar
          cd ../../..
          echo 'rootProject.name = "vosk"' > settings.gradle.kts
          sed -i '' '10d;21,25d' build.gradle
          sed -i '' '80s/^/\/\//' src/main/java/org/vosk/LibVosk.java
          sed -i '' '218s/^/\/\//' src/main/java/org/vosk/Recognizer.java
          gradle publishToMavenLocal

      - name: Checkout jAdapterForNativeTTS
        uses: actions/checkout@v3
        with:
          repository: OpenASR/jAdapterForNativeTTS
          path: jAdapterForNativeTTS
      - name: Build jAdapterForNativeTTS
        run: cd ./jAdapterForNativeTTS && ./gradlew publishToMavenLocal

      - name: Publish Idea
        run: |
          ./gradlew publishPlugin --stacktrace
